name: Flutter CI/CD with Fastlane, Firebase & Telegram

# ============================================
# üéØ CONFIGURATION: Change your app name here
# ============================================
env:
  APP_NAME: "mini-soft-admin"  # ‚Üê Change this to your app display name!
# ============================================


on:
  push:
    branches: [ feature/firebase-fastlane-github-actions ]
  pull_request:
    branches: [ feature/firebase-fastlane-github-actions ]

jobs:

  build-and-distribute:
    name: Build & Distribute to Firebase
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # üì• Checkout Repository
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v3

      # ============================================
      # ‚òï Setup Java
      # ============================================
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17.0.10'

      # ============================================
      # üì± Setup Flutter
      # ============================================
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.1'
          channel: 'stable'

      # ============================================
      # üíé Setup Ruby & Fastlane
      # ============================================
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          working-directory: android

      - name: Fix Gemfile.lock platforms
        working-directory: android
        run: |
          bundle lock --add-platform x86_64-linux
          bundle lock --add-platform ruby
          bundle install

      - name: Install Fastlane
        working-directory: android
        run: |
          gem install bundler
          bundle install

      # ============================================
      # üìä Get Version Information
      # ============================================
      - name: Get version info
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | cut -d ' ' -f 2)
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "COMMIT_MSG=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          
          echo "üì± App Version: ${VERSION}"
          echo "üìù Commit Message: ${COMMIT_MSG}"

      # ============================================
      # üîê Create Firebase Service Account File
      # ============================================
      - name: Create Firebase Service Account JSON
        working-directory: android
        run: |
          echo "üîê Creating service account file..."
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}' > firebase-service-account.json
          
          # Verify file was created
          if [ -f firebase-service-account.json ]; then
            echo "‚úÖ Service account file created successfully"
            echo "üìÑ File size: $(wc -c < firebase-service-account.json) bytes"
          else
            echo "‚ùå Failed to create service account file"
            exit 1
          fi

      # ============================================
      # üöÄ Build & Upload with Fastlane
      # ============================================
      - name: Build and upload to Firebase with Fastlane
        working-directory: android
        env:
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_SERVICE_ACCOUNT_PATH: firebase-service-account.json
          RELEASE_NOTES: |
            üöÄ Version: ${{ steps.version.outputs.VERSION }}
            üìù ${{ steps.version.outputs.COMMIT_MSG }}
            
            üîó Download and install this APK to get the latest version!
        run: |
          echo "üöÄ Starting Fastlane build and distribution..."
          bundle exec fastlane firebase_distribution

      # ============================================
      # üîó Get Firebase Download Link
      # ============================================
      - name: Get Firebase Download Link
        id: firebase_link
        run: |
          # The download link follows this pattern:
          # https://appdistribution.firebase.google.com/pub/i/<FIREBASE_APP_ID>
          
          FIREBASE_APP_ID="${{ secrets.FIREBASE_APP_ID }}"
          
          # Extract the app identifier from the Firebase App ID
          # Format: 1:PROJECT_NUMBER:android:APP_IDENTIFIER
          # We need the full APP_ID for the public link
          
          DOWNLOAD_LINK="https://appdistribution.firebase.google.com/pub/i/${FIREBASE_APP_ID}"
          
          echo "DOWNLOAD_LINK=${DOWNLOAD_LINK}" >> $GITHUB_OUTPUT
          
          echo "================================================"
          echo "üîó Firebase Public Download Link:"
          echo "${DOWNLOAD_LINK}"
          echo "================================================"

      # ============================================
      # üì¢ Send Link to Telegram
      # ============================================
      - name: Send Download Link to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          APP_NAME="${{ env.APP_NAME }}"
          VERSION="${{ steps.version.outputs.VERSION }}"
          COMMIT_MSG="${{ steps.version.outputs.COMMIT_MSG }}"
          DOWNLOAD_LINK="${{ steps.firebase_link.outputs.DOWNLOAD_LINK }}"
          
          # Create formatted message with Markdown
          MESSAGE="üöÄ *New Build Available!*%0A%0A"
          MESSAGE+="üì± *App:* ${APP_NAME}%0A"
          MESSAGE+="üîñ *Version:* ${VERSION}%0A"
          MESSAGE+="üìù *Changes:* ${COMMIT_MSG}%0A%0A"
          MESSAGE+="üîó *Download Link:*%0A${DOWNLOAD_LINK}%0A%0A"
          MESSAGE+="‚úÖ _Click the link above to download and install the latest version_"
          
          echo "üì¢ Sending notification to Telegram..."
          
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=false)
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ Successfully sent notification to Telegram!"
            echo "üì± Message preview:"
            echo "   App: ${APP_NAME}"
            echo "   Version: ${VERSION}"
            echo "   Link: ${DOWNLOAD_LINK}"
          else
            echo "‚ùå Failed to send to Telegram"
            echo "Response: $RESPONSE"
            exit 1
          fi

      # ============================================
      # üßπ Cleanup (Always runs)
      # ============================================
      - name: Cleanup service account file
        if: always()
        working-directory: android
        run: |
          if [ -f firebase-service-account.json ]; then
            echo "üßπ Removing service account file..."
            rm -f firebase-service-account.json
            echo "‚úÖ Service account file removed"
          fi
